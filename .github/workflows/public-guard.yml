name: Public Guard ‚Äî Block Sensitive Keywords

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Scan for sensitive keywords
        run: |
          echo "üîí Scanning for sensitive keywords in public repository..."
          
          KEYWORDS="mavlink|MAVLink|px4|PX4|ros2|ROS2|gazebo|Gazebo|websocket|WebSocket|ws://|wss://|cmd_vel|takeoff_service|land_service|arm_service|disarm|radio://|8765|8000/docs|Jetson|DIAMANTS_BACKEND|DIAMANTS_API|microservice|PositionBroadcaster|SwarmController|SLAMFusion|MissionCoordinator|real_flight|mavproxy|sitl"
          
          # Scan all tracked files except this workflow itself, node_modules, and stub files
          MATCHES=$(grep -rn --include="*.js" --include="*.ts" --include="*.py" --include="*.md" --include="*.json" --include="*.yml" --include="*.yaml" --include="*.sh" --include="*.html" \
            -E "$KEYWORDS" \
            --exclude-dir=node_modules \
            --exclude-dir=.git \
            --exclude="public-guard.yml" \
            --exclude="crazyflie-ros-controller.js" \
            . || true)
          
          if [ -n "$MATCHES" ]; then
            echo "‚ùå BLOCKED ‚Äî Sensitive keywords found:"
            echo "$MATCHES"
            echo ""
            echo "These keywords must not appear in the public repository."
            echo "Move sensitive code to diamants-private."
            exit 1
          fi
          
          echo "‚úÖ No sensitive keywords found ‚Äî safe to merge."
