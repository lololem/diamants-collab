# Makefile pour Projet Diamants
# Reconstruction automatique apr√®s git clone
# Usage: make [target]

# Variables de configuration
SHELL := /bin/bash
PROJECT_ROOT := $(shell pwd)
ROS2_WS := $(PROJECT_ROOT)/slam_collaboratif/ros2_ws
PYTHON_VERSION := 3.12
VENV_DIR := $(PROJECT_ROOT)/.venv

# Couleurs pour l'affichage
GREEN := \033[0;32m
BLUE := \033[0;34m
YELLOW := \033[1;33m
RED := \033[0;31m
NC := \033[0m

.PHONY: all setup install build test clean help status launch-tmux kill-tmux status-tmux post-clone

# Target par d√©faut
all: post-clone ## Configuration compl√®te (recommand√© apr√®s git clone)

help: ## Affiche cette aide
	@echo -e "$(BLUE)üîß PROJET DIAMANTS - MAKEFILE$(NC)"
	@echo "================================="
	@echo ""
	@echo "Targets disponibles:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[1;33m%-15s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "Usage typique apr√®s git clone:"
	@echo -e "  $(GREEN)make$(NC)              - Configuration compl√®te automatique"
	@echo -e "  $(GREEN)make post-clone$(NC)   - Configuration post-clone"
	@echo -e "  $(GREEN)make launch-tmux$(NC)  - Lancer le syst√®me TMUX"
	@echo -e "  $(GREEN)make status-tmux$(NC)  - V√©rifier l'√©tat du syst√®me"

setup: ## Configuration initiale compl√®te du projet
	@echo -e "$(BLUE)üöÄ CONFIGURATION INITIALE PROJET DIAMANTS$(NC)"
	@echo "=============================================="
	@$(MAKE) check-system
	@$(MAKE) setup-permissions
	@$(MAKE) setup-python
	@$(MAKE) setup-ros2
	@$(MAKE) setup-vscode
	@echo -e "$(GREEN)‚úÖ Configuration initiale termin√©e !$(NC)"

check-system: ## V√©rification des pr√©requis syst√®me
	@echo -e "$(BLUE)üîç V√©rification des pr√©requis...$(NC)"
	@command -v python3 >/dev/null 2>&1 || { echo -e "$(RED)‚ùå Python3 requis$(NC)"; exit 1; }
	@command -v git >/dev/null 2>&1 || { echo -e "$(RED)‚ùå Git requis$(NC)"; exit 1; }
	@command -v colcon >/dev/null 2>&1 || echo -e "$(YELLOW)‚ö†Ô∏è  colcon non trouv√© - installation recommand√©e$(NC)"
	@python3 --version | grep -E "3\.(8|9|10|11|12)" >/dev/null || echo -e "$(YELLOW)‚ö†Ô∏è  Python 3.8+ recommand√©$(NC)"
	@echo -e "$(GREEN)‚úì Pr√©requis v√©rifi√©s$(NC)"

setup-permissions: ## Configuration des permissions des scripts
	@echo -e "$(BLUE)üîê Configuration des permissions...$(NC)"
	@chmod +x $(PROJECT_ROOT)/diamants
	@chmod +x $(PROJECT_ROOT)/maintenance
	@chmod +x $(PROJECT_ROOT)/launch.sh
	@find $(PROJECT_ROOT)/scripts -name "*.sh" -exec chmod +x {} \; 2>/dev/null || true
	@find $(PROJECT_ROOT)/scripts/launch -name "*.sh" -exec chmod +x {} \; 2>/dev/null || true
	@find $(PROJECT_ROOT)/archives/maintenance/scripts -name "*.sh" -exec chmod +x {} \; 2>/dev/null || true
	@find $(PROJECT_ROOT)/archives/maintenance/scripts -name "*.py" -exec chmod +x {} \; 2>/dev/null || true
	@echo -e "$(GREEN)‚úì Permissions configur√©es$(NC)"

setup-python: ## Configuration de l'environnement Python
	@echo -e "$(BLUE)üêç Configuration environnement Python...$(NC)"
	@if [ ! -f "$(PROJECT_ROOT)/pyproject.toml" ]; then \
		echo -e "$(YELLOW)‚ö†Ô∏è  pyproject.toml manquant$(NC)"; \
	else \
		echo -e "$(GREEN)‚úì Configuration Python trouv√©e$(NC)"; \
	fi
	@python3 -m pip install --user --upgrade pip setuptools wheel 2>/dev/null || true
	@echo -e "$(GREEN)‚úì Environnement Python configur√©$(NC)"

setup-ros2: ## Configuration du workspace ROS2
	@echo -e "$(BLUE)ü§ñ Configuration workspace ROS2...$(NC)"
	@if [ -d "$(ROS2_WS)" ]; then \
		echo -e "$(GREEN)‚úì Workspace ROS2 trouv√©: $(ROS2_WS)$(NC)"; \
		if command -v colcon >/dev/null 2>&1; then \
			echo -e "$(BLUE)üì¶ Installation des d√©pendances ROS2...$(NC)"; \
			cd $(ROS2_WS) && rosdep update 2>/dev/null || true; \
			cd $(ROS2_WS) && rosdep install --from-paths src --ignore-src -r -y 2>/dev/null || true; \
		else \
			echo -e "$(YELLOW)‚ö†Ô∏è  colcon non disponible - sautant l'installation des d√©pendances$(NC)"; \
		fi; \
	else \
		echo -e "$(YELLOW)‚ö†Ô∏è  Workspace ROS2 non trouv√©$(NC)"; \
	fi

setup-vscode: ## Configuration de VS Code
	@echo -e "$(BLUE)üñ•Ô∏è  Configuration VS Code...$(NC)"
	@if [ -d "$(PROJECT_ROOT)/.vscode" ]; then \
		echo -e "$(GREEN)‚úì Configuration VS Code trouv√©e$(NC)"; \
		if [ -f "$(PROJECT_ROOT)/.vscode/extensions.json" ]; then \
			echo -e "$(BLUE)üìã Extensions recommand√©es configur√©es$(NC)"; \
		fi; \
	else \
		echo -e "$(YELLOW)‚ö†Ô∏è  Configuration VS Code manquante$(NC)"; \
	fi

install: setup ## Installation compl√®te (alias pour setup)

build: ## Construction du workspace ROS2
	@echo -e "$(BLUE)üî® CONSTRUCTION WORKSPACE ROS2$(NC)"
	@echo "==============================="
	@if [ -d "$(ROS2_WS)" ] && command -v colcon >/dev/null 2>&1; then \
		echo -e "$(BLUE)üì¶ Nettoyage ancien build...$(NC)"; \
		cd $(ROS2_WS) && rm -rf build install log 2>/dev/null || true; \
		echo -e "$(BLUE)üî® Construction avec colcon...$(NC)"; \
		cd $(ROS2_WS) && colcon build --cmake-args -DCMAKE_BUILD_TYPE=Release; \
		if [ $$? -eq 0 ]; then \
			echo -e "$(GREEN)‚úÖ Construction r√©ussie !$(NC)"; \
		else \
			echo -e "$(RED)‚ùå Erreur de construction$(NC)"; \
			exit 1; \
		fi; \
	else \
		if [ ! -d "$(ROS2_WS)" ]; then \
			echo -e "$(RED)‚ùå Workspace ROS2 non trouv√©: $(ROS2_WS)$(NC)"; \
		else \
			echo -e "$(RED)‚ùå colcon non disponible$(NC)"; \
		fi; \
		exit 1; \
	fi

test: ## Tests de validation du syst√®me
	@echo -e "$(BLUE)üß™ TESTS DE VALIDATION$(NC)"
	@echo "======================="
	@echo -e "$(BLUE)üß™ Test script principal...$(NC)"
	@if [ -x "$(PROJECT_ROOT)/launch.sh" ]; then \
		echo -e "$(GREEN)‚úì Lanceur principal ex√©cutable$(NC)"; \
	else \
		echo -e "$(RED)‚ùå Lanceur principal manquant$(NC)"; \
	fi
	@echo -e "$(BLUE)üß™ Test structure propre...$(NC)"
	@if [ -x "$(PROJECT_ROOT)/scripts/validation/validate_clean_structure.sh" ]; then \
		echo -e "$(GREEN)‚úì Script de validation disponible$(NC)"; \
		$(PROJECT_ROOT)/scripts/validation/validate_clean_structure.sh; \
	else \
		echo -e "$(RED)‚ùå Script de validation manquant$(NC)"; \
	fi
	@echo -e "$(BLUE)üß™ Test workspace ROS2...$(NC)"
	@if [ -d "$(ROS2_WS)" ]; then \
		echo -e "$(GREEN)‚úì Workspace ROS2 pr√©sent$(NC)"; \
	else \
		echo -e "$(RED)‚ùå Workspace ROS2 manquant$(NC)"; \
	fi

clean: ## Nettoyage des fichiers de build
	@echo -e "$(BLUE)üßπ NETTOYAGE$(NC)"
	@echo "============"
	@echo -e "$(BLUE)üóëÔ∏è  Nettoyage caches Python...$(NC)"
	@find $(PROJECT_ROOT) -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
	@find $(PROJECT_ROOT) -name "*.pyc" -delete 2>/dev/null || true
	@find $(PROJECT_ROOT) -name ".pytest_cache" -type d -exec rm -rf {} + 2>/dev/null || true
	@echo -e "$(BLUE)üóëÔ∏è  Nettoyage build ROS2...$(NC)"
	@if [ -d "$(ROS2_WS)" ]; then \
		cd $(ROS2_WS) && rm -rf build install log 2>/dev/null || true; \
	fi
	@echo -e "$(GREEN)‚úÖ Nettoyage termin√©$(NC)"

clean-all: clean ## Nettoyage complet (+ archives temporaires)
	@echo -e "$(BLUE)üóëÔ∏è  Nettoyage complet...$(NC)"
	@find $(PROJECT_ROOT) -name "*.log" -not -path "$(PROJECT_ROOT)/archives/*" -delete 2>/dev/null || true
	@find $(PROJECT_ROOT) -name ".mypy_cache" -type d -exec rm -rf {} + 2>/dev/null || true
	@echo -e "$(GREEN)‚úÖ Nettoyage complet termin√©$(NC)"

status: ## Affiche le statut du projet
	@echo -e "$(BLUE)üìä STATUT PROJET DIAMANTS$(NC)"
	@echo "=========================="
	@echo -e "$(BLUE)üìÅ Structure:$(NC)"
	@echo "  ‚Ä¢ R√©pertoire: $(PROJECT_ROOT)"
	@echo -e "  ‚Ä¢ ROS2 Workspace: $(if $(wildcard $(ROS2_WS)),$(GREEN)‚úì Pr√©sent$(NC),$(RED)‚úó Manquant$(NC))"
	@echo -e "  ‚Ä¢ Script principal: $(if $(wildcard $(PROJECT_ROOT)/diamants),$(GREEN)‚úì Pr√©sent$(NC),$(RED)‚úó Manquant$(NC))"
	@echo -e "  ‚Ä¢ Configuration VS Code: $(if $(wildcard $(PROJECT_ROOT)/.vscode),$(GREEN)‚úì Pr√©sente$(NC),$(RED)‚úó Manquante$(NC))"
	@echo ""
	@echo -e "$(BLUE)üîß Outils:$(NC)"
	@echo "  ‚Ä¢ Python: $(shell python3 --version 2>/dev/null || echo 'Non trouv√©')"
	@echo "  ‚Ä¢ Git: $(shell git --version 2>/dev/null || echo 'Non trouv√©')"
	@echo "  ‚Ä¢ Colcon: $(shell colcon version 2>/dev/null || echo 'Non trouv√©')"
	@echo ""
	@echo -e "$(BLUE)üöÄ Points d'entr√©e:$(NC)"
	@echo "  ‚Ä¢ ./launch.sh [sim|real]            - Lanceur unique missions"
	@echo "  ‚Ä¢ make run                           - Raccourci simulation"
	@echo "  ‚Ä¢ scripts/validation/validate_clean_structure.sh - Validation structure"
	@echo ""
	@if [ -f "$(PROJECT_ROOT)/archives/maintenance/rapports/VALIDATION_FINALE.json" ]; then \
		echo -e "$(BLUE)‚úÖ Derni√®re validation:$(NC)"; \
		grep -E '"status"|"score"' $(PROJECT_ROOT)/archives/maintenance/rapports/VALIDATION_FINALE.json 2>/dev/null || true; \
	fi

# Target pour reconstruction apr√®s git clone
rebuild: clean setup build test ## Reconstruction compl√®te apr√®s git clone
	@echo -e "$(GREEN)üéâ RECONSTRUCTION TERMIN√âE !$(NC)"
	@echo ""
	@echo "Le projet est pr√™t √† l'utilisation:"
	@echo -e "  $(YELLOW)make launch-tmux$(NC)  - Lancer le syst√®me TMUX complet"
	@echo -e "  $(YELLOW)./launch_slam_collaborative.sh$(NC) - Lanceur interactif"

# Gestion TMUX pour DIAMANTS V3
launch-tmux: ## Lance le syst√®me SLAM collaboratif avec TMUX
	@echo -e "$(BLUE)üöÄ LANCEMENT SYST√àME TMUX DIAMANTS V3$(NC)"
	@echo "==========================================="
	@if ! command -v tmux >/dev/null 2>&1; then \
		echo -e "$(RED)‚ùå TMUX non install√©$(NC)"; \
		echo "Installation: sudo apt install tmux"; \
		exit 1; \
	fi
	@echo -e "$(BLUE)üîÑ Nettoyage sessions TMUX existantes...$(NC)"
	@tmux kill-session -t slam_collab 2>/dev/null || true
	@echo -e "$(BLUE)üì∫ Lancement syst√®me collaboratif...$(NC)"
	@cd $(PROJECT_ROOT) && echo "1" | ./launch_slam_collaborative.sh

kill-tmux: ## Arr√™te toutes les sessions TMUX DIAMANTS
	@echo -e "$(BLUE)üõë ARR√äT SESSIONS TMUX$(NC)"
	@echo "======================="
	@tmux kill-session -t slam_collab 2>/dev/null || echo "Aucune session slam_collab active"
	@pkill -f "gazebo\|rviz\|ros2" 2>/dev/null || echo "Aucun processus ROS2/Gazebo actif"
	@echo -e "$(GREEN)‚úÖ Nettoyage termin√©$(NC)"

status-tmux: ## Affiche le statut des sessions TMUX
	@echo -e "$(BLUE)üìä STATUT TMUX DIAMANTS V3$(NC)"
	@echo "============================"
	@if tmux list-sessions 2>/dev/null | grep -q slam_collab; then \
		echo -e "$(GREEN)‚úÖ Session slam_collab active$(NC)"; \
		tmux list-windows -t slam_collab; \
	else \
		echo -e "$(YELLOW)‚ö†Ô∏è  Aucune session slam_collab active$(NC)"; \
	fi
	@echo ""
	@echo "Commandes utiles:"
	@echo -e "  $(YELLOW)tmux attach -t slam_collab$(NC)  - Se connecter √† la session"
	@echo -e "  $(YELLOW)make kill-tmux$(NC)               - Arr√™ter le syst√®me"

# Configuration post-clone automatique
post-clone: ## Configuration automatique compl√®te apr√®s git clone
	@echo -e "$(BLUE)üîÑ CONFIGURATION POST-CLONE DIAMANTS V3$(NC)"
	@echo "=============================================="
	@$(MAKE) check-system
	@$(MAKE) setup
	@$(MAKE) build
	@echo -e "$(BLUE)üß™ Test rapide du syst√®me...$(NC)"
	@$(MAKE) test
	@echo -e "$(GREEN)üéâ SYST√àME PR√äT !$(NC)"
	@echo ""
	@echo "Prochaines √©tapes:"
	@echo -e "  $(YELLOW)make launch-tmux$(NC)    - Lancer le syst√®me complet"
	@echo -e "  $(YELLOW)make status-tmux$(NC)    - V√©rifier l'√©tat TMUX"

run: ## Lance la simulation multi-drones (√©quiv. ./launch.sh sim)
	@$(PROJECT_ROOT)/launch.sh sim

# Targets pour d√©veloppement
dev-setup: setup ## Configuration pour d√©veloppement
	@echo -e "$(BLUE)üõ†Ô∏è  Configuration d√©veloppement...$(NC)"
	@python3 -m pip install --user black flake8 mypy pytest 2>/dev/null || true
	@echo -e "$(GREEN)‚úì Outils de d√©veloppement install√©s$(NC)"

dev-test: ## Tests de d√©veloppement √©tendus
	@echo -e "$(BLUE)üß™ Tests de d√©veloppement...$(NC)"
	@if command -v flake8 >/dev/null 2>&1; then \
		echo -e "$(BLUE)üìè V√©rification style avec flake8...$(NC)"; \
		find $(PROJECT_ROOT) -name "*.py" -not -path "$(PROJECT_ROOT)/external_deps/*" -exec flake8 {} + 2>/dev/null || true; \
	fi
	@$(MAKE) test

# Raccourcis pratiques
install-deps: setup-ros2 ## Installation des d√©pendances seulement
compile: build ## Alias pour build
validate: test ## Alias pour test

# Target d'information
info: ## Informations sur le projet
	@echo -e "$(BLUE)‚ÑπÔ∏è  PROJET DIAMANTS V3$(NC)"
	@echo "========================"
	@echo "Version: 3.0.0-Production"
	@echo "Syst√®me SLAM collaboratif multi-drones avec TMUX"
	@echo ""
	@echo "Workflow apr√®s git clone:"
	@echo -e "  $(YELLOW)1. make$(NC)              - Configuration automatique"
	@echo -e "  $(YELLOW)2. make launch-tmux$(NC)  - Lancer le syst√®me"
	@echo -e "  $(YELLOW)3. make status-tmux$(NC)  - V√©rifier l'√©tat"
	@echo ""
	@echo "Gestion TMUX:"
	@echo -e "  $(YELLOW)tmux attach -t slam_collab$(NC)  - Se connecter"
	@echo -e "  $(YELLOW)make kill-tmux$(NC)               - Arr√™ter le syst√®me"
